<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LatestRouteFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">au.com.realestate.hometime.timetable.latestcomingroute</a> &gt; <span class="el_source">LatestRouteFragment.kt</span></div><h1>LatestRouteFragment.kt</h1><pre class="source lang-java linenums">package au.com.realestate.hometime.timetable.latestcomingroute

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.TextView
import androidx.core.content.ContextCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.Observer
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import androidx.swiperefreshlayout.widget.SwipeRefreshLayout
import au.com.realestate.hometime.R
import au.com.realestate.hometime.common.RouteComparator
import au.com.realestate.hometime.common.RouteDirectionComparator
import butterknife.BindView
import butterknife.ButterKnife
import butterknife.Unbinder
import com.google.android.material.snackbar.Snackbar
import org.koin.androidx.viewmodel.ext.android.viewModel
import java.text.SimpleDateFormat
import java.util.*

class LatestRouteFragment : Fragment() {

    private val viewModel by viewModel&lt;LatestRouteFragmentViewModel&gt;()

    private val dateFormat = SimpleDateFormat(&quot;h:mm a&quot;, Locale.getDefault())

    companion object {
<span class="fc" id="L32">        val TAG: String = LatestRouteFragment::class.java.simpleName</span>

        fun newInstance(): LatestRouteFragment {
<span class="fc" id="L35">            return LatestRouteFragment()</span>
        }
    }

    @BindView(R.id.root_view)
    lateinit var rootView: ViewGroup

    @BindView(R.id.swipe_refresh_layout)
    lateinit var swipeRefreshLayout: SwipeRefreshLayout

    @BindView(R.id.recycler_view)
    lateinit var recyclerView: RecyclerView

    @BindView(R.id.last_updated_time_text_view)
    lateinit var lastUpdatedTimeTextView: TextView

    private lateinit var unbinder: Unbinder

    private lateinit var latestTramRecyclerViewAdapter: LatestRouteRecyclerViewAdapter

    private var errorRefreshingSnackbar: Snackbar? = null

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
        val view = inflater.inflate(R.layout.fragment_latest_coming_tram, container, false)
        unbinder = ButterKnife.bind(this, view)

        latestTramRecyclerViewAdapter =
                LatestRouteRecyclerViewAdapter(RouteDirectionComparator, RouteComparator)

        recyclerView.apply {
            layoutManager = LinearLayoutManager(this@LatestRouteFragment.context)
            adapter = latestTramRecyclerViewAdapter
        }

        swipeRefreshLayout.apply {
            setOnRefreshListener(onSwipeRefreshListener)
            setColorSchemeResources(R.color.colorSecondary)
        }

        viewModel.refreshingRoute()

        return view
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        viewModel.lastUpdatedDateTime.observe(this, Observer { lastUpdatedDateTime -&gt;
            lastUpdatedDateTime
<span class="fc bfc" id="L84" title="All 2 branches covered.">                ?.let {</span>
<span class="fc" id="L85">                    val formattedDateTime = dateFormat.format(lastUpdatedDateTime)</span>
<span class="fc" id="L86">                    lastUpdatedTimeTextView.text = getString(R.string.time_last_update_dated, formattedDateTime)</span>
<span class="fc" id="L87">                    lastUpdatedTimeTextView.visibility = View.VISIBLE</span>
<span class="fc" id="L88">                }</span>
<span class="fc" id="L89">                ?: let {</span>
<span class="fc" id="L90">                    lastUpdatedTimeTextView.visibility = View.GONE</span>
<span class="fc" id="L91">                }</span>
<span class="fc" id="L92">        })</span>

        viewModel.tramsWithDirection.observe(this, Observer { tramsWithDirection -&gt;
<span class="fc" id="L95">            latestTramRecyclerViewAdapter.headerWithRoutesMap = tramsWithDirection</span>
<span class="fc" id="L96">        })</span>

        viewModel.shouldPopErrorSnackbar.observe(this, Observer { shouldPopErrorSnackbar -&gt;
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            val snackbarAlreadyShown = errorRefreshingSnackbar?.isShownOrQueued ?: false</span>

<span class="pc bpc" id="L101" title="3 of 4 branches missed.">            if (shouldPopErrorSnackbar &amp;&amp; !snackbarAlreadyShown) {</span>
<span class="nc" id="L102">                errorRefreshingSnackbar = Snackbar.make(</span>
<span class="nc" id="L103">                    rootView,</span>
<span class="nc" id="L104">                    getString(R.string.error_message_could_not_refresh_routes),</span>
<span class="nc" id="L105">                    Snackbar.LENGTH_LONG</span>
<span class="nc" id="L106">                ).setAction(getString(R.string.action_retry), retryCallback)</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                context?.let { notNullContext -&gt;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    errorRefreshingSnackbar?.let {</span>
<span class="nc" id="L109">                        it.setActionTextColor(ContextCompat.getColor(notNullContext, R.color.colorTextLight))</span>
<span class="nc" id="L110">                        it.show()</span>
<span class="nc" id="L111">                    }</span>
                }
            } else {
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">                errorRefreshingSnackbar?.dismiss()</span>
            }
<span class="fc" id="L116">        })</span>

        viewModel.refreshing.observe(this, Observer { refreshing -&gt;
<span class="fc" id="L119">            swipeRefreshLayout.isRefreshing = refreshing</span>
<span class="fc" id="L120">        })</span>

    }

    override fun onDestroyView() {
        super.onDestroyView()
        unbinder.unbind()
    }

    private val retryCallback: View.OnClickListener = View.OnClickListener {
<span class="nc" id="L130">        viewModel.refreshingRoute()</span>
<span class="nc" id="L131">    }</span>

    private val onSwipeRefreshListener: SwipeRefreshLayout.OnRefreshListener = SwipeRefreshLayout.OnRefreshListener {
<span class="nc" id="L134">        viewModel.refreshingRoute()</span>
<span class="nc" id="L135">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>